## Library
library(magrittr)
library(tidyr)

## Working Directory
setwd("/Users/kayabayuki/Individual/001_University/01_PhD_program/04_Thesis/01.Master_thesis/Data/Main")

## Read data
airline <- read.csv("airline.csv", header = T)
ODforairline <- read.csv("ODforairline.csv", header = T)
data <- read.csv("data.csv", header = T)
station <- read.csv("station.csv", header = T)
airport <- read.csv("airport.csv", header = T)
combine <- read.csv("combine.csv", header = T)
railway <- read.csv("railway.csv", header = T)
railwaycost <- read.csv("railwaycost.csv", header = T)
OD <- read.csv("OD.csv", header = T, stringsAsFactors = FALSE)
accessibility.station <- read.csv("accessibility_station.csv", header = T)
accessibility.airport <- read.csv("accessibility_airport.csv", header = T)
OD.207 <- read.csv("207OD.csv", header = T)

dataframe.railway <- read.csv("dataframe_railway.csv", header = T)
dataframe.airline <- read.csv("dataframe_airline.csv", header = T)
## Combine airports
## ?]?T?????Î’???
for(k in 1:2){
  for(i in 1:174){
    for(j in 1:8){
      if(airline[i, k+1] == combine[j, 1]){
        airline[i, k+3] <- combine[j, 3]
      } else {
        
      }
    }
  }
}
## ?q???^?ï¿½ï¿½??????Å“??ï¿½ï¿½Ä‚????Ì‚Å•Ğ“??^?ï¿½ï¿½É‚???
airline$???p <- airline$???p/2

## Combine ODs
airline <- airline %>% 
  dplyr::group_by(???`i, ???`j) %>% 
  dplyr::mutate(i = min(i),
                j = min(j),
                freq = 365*sum(?q???Ö?), ## ?q???Ö??ÍŠÛ‚ß‚é•”???ÉŠÖ‚??Ä‚Í‘??a?Å????????A?Å‚?????365?{????
                cost = sum(?q???Ö? * ???p)/sum(?q???Ö?), ## ?P?????Ï‚????ï¿½ï¿½d???Ï‚É????Ö‚???
                duration = sum(?q???Ö? * ???v????)/sum(?q???Ö?), ## ???????ï¿½ï¿½d????
                stay = max(?Øİ‰Â”\????), ## ?????Í•??Ï‚????Å‘??l?É•Ï‚???
                entry = mean(?G?A???C???Q???Ğ?)) %>% 
  dplyr::summarise_each(dplyr::funs(mean), 
                        vars = c('i', 'j', 'duration', 'cost', 'freq', 'stay', 'entry'))
colnames(airline) <- c("???`i", "???`j", "i", "j", "???v????", "???p", "?q???Ö?", "?Øİ‰Â”\????", "?G?A???C???Q????")

# Insert airline data into the whole 
dataframe.airline <- merge(dataframe.airline, airline, by.x = c("X47?]?[??i", "X47?]?[??j"), 
                           by.y = c("i", "j"), all.x = T)

# Transform ???v???? and ?Øİ‰Â”\???? and cost into numeric
railway$???v????.1 <-as.numeric(as.character(railway$???v????.1))
railway$?Øİ‰Â”\????.1 <- as.numeric(as.character(railway$?Øİ‰Â”\????.1))
railwaycost$cost <- as.numeric(as.character(railwaycost$cost))

## Insert railways duration, stay, and cost data  
dataframe.railway <- merge(dataframe.railway, railway, by.x = c("?ÅŠ???i", "?ÅŠ???j"), 
                           by.y = c("i", "j"), all.x = T)
dataframe.railway <- merge(dataframe.railway, railwaycost, by.x = c("?ÅŠ???i", "?ÅŠ???j"), 
                           by.y = c("?wi", "?wj"), all.x = T)


## Accessibility
dataframe.airline <- merge(dataframe.airline, accessibility.airport, by.x = c("X207?]?[????j"), 
                           by.y = "?]?[??", all.x = T)
dataframe.airline <- merge(dataframe.airline, accessibility.airport, by.x = c("X207?]?[????i"), 
                           by.y = "?]?[??", all.x = T)
dataframe.airline <- dataframe.airline %>% 
  dplyr::mutate(?A?N?Z?V?r???e?B = ?A?N?Z?V?r???e?B.x + ?A?N?Z?V?r???e?B.y)
dataframe.railway <- merge(dataframe.railway, accessibility.station, by.x = c("X207?]?[????j"), 
                           by.y = "?]?[??", all.x = T)
dataframe.railway <- merge(dataframe.railway, accessibility.station, by.x = c("X207?]?[????i"), 
                           by.y = "?]?[??", all.x = T)
dataframe.railway <- dataframe.railway %>% 
  dplyr::mutate(?A?N?Z?V?r???e?B = ?A?N?Z?V?r???e?B.x + ?A?N?Z?V?r???e?B.y)


### ???????Ô‚ñ‚¯‚?===============================
## Insert 1s into ?q???Ö? if railway dummy is equal to 1, so that ln(?q???Ö?) will be zero when the dummy is 1
for(i in 1:nrow(data)){
  if(data[i, 20]==1){
    data[i, c(17, 21)] <- c(1, 0)
  } else {
    
  }
}

## ?????Ü‚?==========================================
## OD
dataframe.airline <- merge(dataframe.airline, OD.207, by.x = c("X207?]?[??i", "X207?]?[??j"), 
                           by.y = c("X207?]?[??i", "X207?]?[??j"), all.x = T)
dataframe.railway <- merge(dataframe.railway, OD.207, by.x = c("X207?]?[??i", "X207?]?[??j"), 
                           by.y = c("X207?]?[??i", "X207?]?[??j"), all.x = T)


## Make new variables
dataframe.airline <- dataframe.airline %>% 
  dplyr::mutate(?S???_?~?[ = 0)
dataframe.railway <- dataframe.railway %>% 
  dplyr::mutate(?S???_?~?[ = 1, 
                ?q???Ö? = 1, 
                ?G?A???C???Q???? = 0)
## Drop variables
dataframe.airline <- dataframe.airline[ , c(7, 8, 1, 2, 5, 6, 3, 4, 13, 14, 15, 16, 20, 31, 17, 24, 30, 29)]
dataframe.railway <- dataframe.railway[, c(7, 8, 1, 2, 9, 10, 3, 4, 30, 35, 50, 31, 38, 49, 51, 43, 48, 47, 34)]

colnames(dataframe.airline) <- c("i", "j", "207?]?[??i", "207?]?[??j", "47?]?[??i", "47?]?[??j", 
                                 "207?]?[????i", "207?]?[????j", "???v????", "???p", "?q???Ö?", 
                                 "?Øİ‰Â”\????", "?A?N?Z?V?r???e?B", "?S???_?~?[", "?G?A???C???Q????", 
                                 "x", "OD1", "OD2")
colnames(dataframe.railway) <- c("i", "j", "207?]?[??i", "207?]?[??j", "47?]?[??i", "47?]?[??j", 
                                 "207?]?[????i", "207?]?[????j", "???v????", "???p", "?q???Ö?", 
                                 "?Øİ‰Â”\????", "?A?N?Z?V?r???e?B", "?S???_?~?[", "?G?A???C???Q????", 
                                 "x", "OD1", "OD2")

## =================================================================================================================
## Add airline data for IV estimation
## This is what I add on Decenber 14
airline.as.IV <- read.csv("airline_updated.csv", header = T)
airport.number <- read.csv("airportNo47.csv", header = T)

airline.as.IV <- merge(airline.as.IV, airport.number, by.x = c("???`i"), 
                       by.y = "???`", all.x = T)
airline.as.IV <- merge(airline.as.IV, airport.number, by.x = c("???`j"), 
                       by.y = "???`", all.x = T)

## Drop rows with NA
airline.as.IV <- airline.as.IV[-which(is.na(airline.as.IV$No.x) | is.na(airline.as.IV$No.y)), ]
airline.as.IV <- airline.as.IV %>% 
  dplyr::group_by()

## Delete commas
airline.as.IV$?l?L?????[?g?? <- as.numeric(gsub(",", "", airline.as.IV$?l?L?????[?g??))
airline.as.IV$?ï¿½ï¿½ÈƒL?????[?g?? <- as.numeric(gsub(",", "", airline.as.IV$?ï¿½ï¿½ÈƒL?????[?g??))
airline.as.IV$?İ•? <- as.numeric(gsub(",", "", airline.as.IV$?İ•?))
airline.as.IV$???ß??×•? <- as.numeric(gsub(",", "", airline.as.IV$???ß??×•?))
airline.as.IV$?X?Ö•? <- as.numeric(gsub(",", "", airline.as.IV$?X?Ö•?))
airline.as.IV$???q <- as.numeric(gsub(",", "", airline.as.IV$???q))
airline.as.IV$?X?Ö•? <- as.numeric(gsub(",", "", airline.as.IV$?X?Ö•?))
airline.as.IV$?İ•?.1 <- as.numeric(gsub(",", "", airline.as.IV$?İ•?.1))
airline.as.IV$???ß??×•?.1 <- as.numeric(gsub(",", "", airline.as.IV$???ß??×•?.1))
airline.as.IV$?X?Ö•?.1 <- as.numeric(gsub(",", "", airline.as.IV$?X?Ö•?.1))
airline.as.IV$?v <- as.numeric(gsub(",", "", airline.as.IV$?v))
airline.as.IV$???p?Â”\.?g???L?????[?g?? <- as.numeric(gsub(",", "", airline.as.IV$???p?Â”\.?g???L?????[?g??))

airline.as.IV <- airline.as.IV %>% 
  dplyr::mutate(???Ö‚??????ï¿½ï¿½È? = ?ï¿½ï¿½È?/?^?q????, 
                        ???Ö‚??????İ•? = ?İ•?/?^?q????, 
                        ???Ö‚????è’´?ß??×•? = ???ß??×•?/?^?q????, 
                        ?H?????? = ?^?q?L?????[?g??/?^?q????)

airline.as.IV <- airline.as.IV[, c(28:33)]

airline.as.IV <- airline.as.IV %>% 
  dplyr::group_by(No.x, No.y) %>% 
  dplyr::summarise_each(dplyr::funs(mean), 
                        vars = c('???Ö‚??????ï¿½ï¿½È?', '???Ö‚??????İ•?', '???Ö‚????è’´?ß??×•?', '?H??????'))
colnames(airline.as.IV) <- c("i", "j", "???Ö‚??????ï¿½ï¿½È?", "???Ö‚??????İ•?", "???Ö‚????è’´?ß??×•?", "?H??????")

dataframe.airline <- merge(dataframe.airline, airline.as.IV, by.x = c("47?]?[??i", "47?]?[??j"), 
                           by.y = c("i", "j"), all.x = T)
dataframe.airline$???Ö‚??????ï¿½ï¿½È?[which(is.na(dataframe.airline$???Ö‚??????ï¿½ï¿½È?))] <- 0
dataframe.airline$???Ö‚??????İ•?[which(is.na(dataframe.airline$???Ö‚??????İ•?))] <- 0
dataframe.airline$???Ö‚????è’´?ß??×•?[which(is.na(dataframe.airline$???Ö‚????è’´?ß??×•?))] <- 0
dataframe.airline$?H??????[which(is.na(dataframe.airline$?H??????))] <- 0

colnames(dataframe.railway)[19] <- "?H??????"
dataframe.railway <- dataframe.railway %>% 
  dplyr::mutate(???Ö‚??????ï¿½ï¿½È? = 0, ???Ö‚??????İ•? = 0, ???Ö‚????è’´?ß??×•? = 0)

dataframe.airline <- dataframe.airline[ , c(3:6, 1:2, 7:18, 22, 19:21)]
## ==============================================================================================================

## Combine dataframe
dataframe <- rbind(dataframe.airline, dataframe.railway)
dataframe <- dataframe %>% 
  dplyr::arrange(i, j)
write.csv(dataframe, "dataframe?m?F.csv")


## Compute share and outside share
dataframe <- dataframe %>% 
  dplyr::mutate(prob1 = x/OD1, prob2 = x/OD2) %>% 
  dplyr::mutate(share1 = ifelse(prob1 == 0, 1e-3, ifelse(prob1 == 1, 1 - 1e-3, prob1)), 
                share2 = ifelse(prob2 == 0, 1e-3, ifelse(prob2 == 1, 1 - 1e-3, prob2))) %>% 
  dplyr::group_by(i, j) %>% 
  dplyr::mutate(out.share2 = 1 - sum(share2)) %>% 
  dplyr::ungroup()

write.csv(dataframe.airline, "dataframe_airline?m?F.csv")
write.csv(dataframe.railway, "dataframe_railway?m?F.csv")
write.csv(dataframe, "dataframe?m?F.csv")

## If succesful, data for utility analysis is named as demand
demand <- dataframe ## Probably have to revise it! We have to leave share and out.share
demand <- demand %>% 
  dplyr::mutate(y = log(share1) - log(1 - share1))

## Write csv file
write.csv(demand, "(demand):1){
  if(is.na(demand[i, 10])){
    demand <- demand[-i, ]
  } else {
    
  }
}
demand <- demand[-which(is.na(demand$y) | is.na(demand$???v????) | is.na(demand$???p) | is.na(demand$?q???Ö?) | is.na(demand$?Øİ‰Â”\????) 
                        | is.na(demand$?A?N?Z?V?r???e?B) | is.na(demand$?S???_?~?[) | is.na(demand$?G?A???C???Q????)), ]


## Correlation matrix
cor.mat <- cor(demand[ , c(9, 10, 11, 12, 13, 14, 15)])
cor.mat <- format(round(cor.mat, 3), 3)

xtable::xtable(cor.mat, align = T)
corrplot::corrplot(cor(demand[ , c(9, 10, 11, 12, 13, 14, 15)]))

## Estimate parameters of utility function
logit0.1 <- lm(data = demand, y ~ ???p + log(?q???Ö?), 
               na.action = na.omit)
logit0.2 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v????, 
               na.action = na.omit)
logit0.3 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?Øİ‰Â”\????, 
               na.action = na.omit)
logit0.4 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B, 
               na.action = na.omit)
logit0.5 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?S???_?~?[, 
               na.action = na.omit)
logit0.6 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?G?A???C???Q????, 
               na.action = na.omit)

logit_summary <- stargazer::stargazer(logit0.1, logit0.2, logit0.3, logit0.4, logit0.5, logit0.6, 
                                      type = "latex", no.space = T, omit.stat=c("f","ser"))


logit1.1 <- lm(data = demand, y ~ ???p + log(?q???Ö?), 
            na.action = na.omit)
logit1.2 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v????, 
            na.action = na.omit)
logit1.3 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v???? + ?Øİ‰Â”\????, 
            na.action = na.omit)
logit1.4 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v???? + ?Øİ‰Â”\???? + ?A?N?Z?V?r???e?B, 
            na.action = na.omit)
logit1.5 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v???? + ?Øİ‰Â”\???? + ?A?N?Z?V?r???e?B + ?S???_?~?[, 
            na.action = na.omit)
logit1.6 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ???v???? + ?Øİ‰Â”\???? + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ?G?A???C???Q????, 
            na.action = na.omit)

logit_summary <- stargazer::stargazer(logit1.1, logit1.2, logit1.3, logit1.4, logit1.5, logit1.6, 
                                      type = "latex", no.space = T, omit.stat=c("f","ser"))


logit9 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B, 
             na.action = na.omit)
logit10 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[, 
             na.action = na.omit)
logit11 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ?G?A???C???Q????, 
             na.action = na.omit)
logit_summary <- stargazer::stargazer(logit9, logit10, logit11, 
                                      type = "latex", no.space = T, omit.stat=c("f","ser"))

## IV Estimation
## IVs are ???v????, ?G?A???C???Q????, ?Øİ‰Â”\????
IVreg <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ | 
                 ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[) ## ???Á‚????q???Ö???365?{?Å???
IVreg2 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ | 
                     ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                     ?H?????? + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•? + ???Ö‚????è’´?ß??×•?)
IVreg3 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ | 
                       ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                       ?H?????? + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•?)
IVreg4 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ | 
                       ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                       ?H?????? + ???Ö‚??????ÀÈ?)
IVreg5 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ???Ö‚??????ÀÈ? | 
                       ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                       ?H?????? + ???Ö‚??????ÀÈ?)
IVreg6 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ???Ö‚??????ÀÈ? + 
                       ???Ö‚??????İ•? | ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                       ?H?????? + ???Ö‚??????ÀÈ?)
IVreg7 <- AER::ivreg(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•? + ???v????| 
                       ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
                       ?H?????? + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•? + ???Ö‚????è’´?ß??×•?)
logit7.1 <- lm(data = demand, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ???Ö‚??????ÀÈ? + + ???Ö‚??????İ•? + ???v????)

TSLS1 <- lm(data = demand, ???p ~ ???v???? + ?G?A???C???Q???? + ?Øİ‰Â”\???? + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + 
              ?H?????? + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•? + ???Ö‚????è’´?ß??×•?)
data.for.2SLS <- demand
data.for.2SLS$???p <- TSLS1$fitted.values
TSLS2 <- lm(data = data.for.2SLS, y ~ ???p + log(?q???Ö?) + ?A?N?Z?V?r???e?B + ?S???_?~?[ + ???Ö‚??????ÀÈ? + ???Ö‚??????İ•? + ???v????)
summary <- stargazer::stargazer(logit7.1, TSLS2, type = "latex", no.space = T, omit.stat=c("f","ser"), 
                                column.labels = c("OLS", "IV"), )

TSLS2$coefficients
IVreg7$coefficients
logit7.1$coefficients
## Estimation Results
coef_logit <- c(logit10$coefficients)
coef_IV <- c(IVreg$coefficients)
coef_IV2 <- c(IVreg2$coefficients)
coef <- rbind(coef_logit, coef_IV, coef_IV2)
coef <- format(round(coef, 4), 3)
colnames(coef) <- c("intercept", "price", "log(frequency)", "acceessibility", "railwaydummy")
rownames(coef) <- c("OLS", "IV", "IV2")
xx2 <- Hmisc::latex(coef, file = "Estimation_results2.tex", 
                    caption = "Estimation Results", 
                    where = "h", 
                    col.just = rep("r", dim(coef)[2]))
xx2

## Maximum likelihood estimation with sign restriction
## Write a function
fr <- function(x){
  LL <- 0
  for(i in 1:nrow(demand)){
    X <- x[1] + x[2]*demand$???v????[i] - (x[3]^2)*demand$???p[i] + (x[4]^2)*log(demand$?q???Ö?[i]) + 
      x[5]*demand$?Øİ‰Â”\????[i] + x[6]*demand$?A?N?Z?V?r???e?B[i] + x[7]*demand$?S???_?~?[[i] + x[8]*demand$?G?A???C???Q????[i]
    Y <- demand$y[i]
    LLL <- (Y - X)^2
    LL <- LL + LLL
  }
  return(LL)
}

logit2.0 <- optim(c(rep(0, 8)), fr, method = "BFGS", hessian = TRUE, control = list(fnscale = 1))
par.sign <- logit2.0$par
par.sign[3] <- -(par.sign[3])^2
par.sign[4] <- par.sign[4])^2
par.sign

## Finally we get utility parameters
logitpar <- logit10$coefficients
IVpar <- IVreg$coefficients
IVpar2 <- IVreg2$coefficients